name: Continuous Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode to run'
        required: false
        default: 'pr-checks'
        type: choice
        options:
          - pr-checks
          - full
          - integration
          - load

jobs:
  # ===================================================
  # Suite 1: Backend Unit Tests (Fast, Always Run)
  # ===================================================
  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Set database credentials for tests
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/trickgame_test
      PGHOST: localhost
      PGUSER: postgres
      PGPASSWORD: postgres
      PGDATABASE: trickgame_test
      NODE_ENV: test

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: trickgame_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d trickgame_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        run: |
          cd backend
          npm ci

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for postgres..."
            sleep 1
          done

      - name: Initialize test database
        run: |
          cd backend
          npm run db:init || true

      - name: Run backend unit tests
        run: |
          cd backend
          npm test -- --run --reporter=verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/coverage/
          retention-days: 7

  # ===================================================
  # Suite 2: Smoke Tests (Fast, Always Run)
  # ===================================================
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: backend-unit-tests

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/trickgame_test
      NODE_ENV: test

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: trickgame_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for postgres..."
            sleep 1
          done

      - name: Initialize database
        run: |
          cd backend
          npm run db:init || true

      - name: Start backend server
        run: |
          cd backend
          npm run dev &
          echo $! > backend.pid
        env:
          PORT: 3001

      - name: Wait for backend
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:3001/api/health; do sleep 1; done'

      - name: Run smoke tests
        run: npm run test:smoke
        env:
          BACKEND_URL: http://localhost:3001

      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
          fi

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: tests/smoke/*.log
          retention-days: 7

  # ===================================================
  # Suite 3: Integration Tests (E2E Core)
  # ===================================================
  integration-tests:
    name: Integration Tests (E2E Core)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    needs: [backend-unit-tests, smoke-tests]

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/trickgame_test
      NODE_ENV: test

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: trickgame_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci
          cd ../frontend && npm ci
          cd ../e2e && npm ci
          npx playwright install --with-deps

      - name: Initialize database
        run: |
          cd backend
          npm run db:init || true

      - name: Run integration tests
        run: npm run test:integration
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: e2e/test-results/
          retention-days: 14

      - name: Upload playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-playwright-report
          path: e2e/playwright-report/
          retention-days: 14

  # ===================================================
  # Suite 4: Load Tests (Optional, Manual Trigger)
  # ===================================================
  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_mode == 'load'

    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/trickgame_test
      NODE_ENV: test

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: trickgame_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          cd backend && npm ci

      - name: Initialize database
        run: |
          cd backend
          npm run db:init || true

      - name: Start backend server
        run: |
          cd backend
          npm run dev &
          echo $! > backend.pid
        env:
          PORT: 3001

      - name: Wait for backend
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:3001/api/health; do sleep 1; done'

      - name: Run load tests (baseline)
        run: npm run test:load:baseline
        env:
          BACKEND_URL: http://localhost:3001

      - name: Stop backend
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
          fi

      - name: Upload load test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: tests/load/*.log
          retention-days: 30

  # ===================================================
  # Report Status (Summary)
  # ===================================================
  report-status:
    name: Report Status
    runs-on: ubuntu-latest
    needs: [backend-unit-tests, smoke-tests, integration-tests]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Unit Tests | ${{ needs.backend-unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const unitResult = '${{ needs.backend-unit-tests.result }}';
            const smokeResult = '${{ needs.smoke-tests.result }}';
            const integrationResult = '${{ needs.integration-tests.result }}';

            const allPassed = unitResult === 'success' && smokeResult === 'success' && integrationResult === 'success';
            const status = allPassed ? '✅' : '❌';

            const comment = `
            ## Test Results ${status}

            | Test Suite | Status | Runtime |
            |------------|--------|---------|
            | Backend Unit Tests (451 tests) | ${unitResult === 'success' ? '✅ Passed' : '❌ Failed'} | ~7s |
            | Smoke Tests (5 actions) | ${smokeResult === 'success' ? '✅ Passed' : '❌ Failed'} | ~10s |
            | Integration Tests (~150 tests) | ${integrationResult === 'success' ? '✅ Passed' : '❌ Failed'} | ~10min |

            ${allPassed ? '✅ All tests passed! Ready to merge.' : '⚠️ Some tests failed. Please review the logs.'}

            [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
